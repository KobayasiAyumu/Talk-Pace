<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talk Pace - Interview Coach</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { color: #444; margin-bottom: 10px; }
        p { color: #666; font-size: 0.9rem; margin-bottom: 30px; }

        .main-panel {
            background: white;
            width: 100%;
            max-width: 600px;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        /* „É°„Éº„Çø„Éº */
        .meter-container {
            position: relative; width: 200px; height: 100px; margin: 0 auto 20px; overflow: hidden;
        }
        .meter-bg {
            width: 200px; height: 200px; background: #eee; border-radius: 50%;
            position: absolute; top: 0; left: 0;
        }
        .meter-fill {
            width: 200px; height: 200px;
            background: conic-gradient(
                #3498db 0% 33%,
                #2ecc71 33% 66%,
                #e74c3c 66% 100%
            );
            border-radius: 50%; position: absolute; top: 0; left: 0;
            transform: rotate(-90deg); clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%); opacity: 0.3;
        }
        .needle {
            width: 4px; height: 90px; background: #333; position: absolute; bottom: 0; left: 50%;
            transform-origin: bottom center; transform: rotate(-90deg); transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 4px; z-index: 10;
        }
        .needle-cover {
            width: 20px; height: 20px; background: #333; border-radius: 50%;
            position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); z-index: 11;
        }

        .speed-value { font-size: 3rem; font-weight: bold; color: #333; font-variant-numeric: tabular-nums; }
        .speed-unit { font-size: 0.9rem; color: #888; }
        
        .feedback-badge {
            display: inline-block; padding: 5px 15px; border-radius: 20px; color: white;
            font-weight: bold; margin-top: 10px; background: #ccc; font-size: 0.9rem;
        }

        .transcript-box {
            width: 100%; height: 150px; margin-top: 20px; padding: 15px; border: 2px solid #eee;
            border-radius: 10px; resize: none; font-size: 1rem; line-height: 1.6; background: #fafafa; box-sizing: border-box;
        }

        .btn-mic {
            background: #e74c3c; color: white; border: none; width: 70px; height: 70px; border-radius: 50%;
            font-size: 30px; cursor: pointer; box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            transition: 0.2s; margin-top: 20px; display: flex; align-items: center; justify-content: center;
        }
        .btn-mic.recording {
            animation: pulse 1.5s infinite; background: #fff; border: 4px solid #e74c3c; color: #e74c3c;
        }
        .btn-mic:hover { transform: scale(1.05); }

        /* „Ç®„É©„ÉºË°®Á§∫Áî® */
        .error-msg { color: #e74c3c; font-size: 12px; margin-top: 10px; font-weight: bold; min-height: 18px; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(231, 76, 60, 0); }
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
        }

    </style>
</head>
<body>

    <h1>üé§ Talk Pace</h1>
    <p>Èù¢Êé•Á∑¥ÁøíÁî®ÔºöË©±„Åô„Çπ„Éî„Éº„Éâ„Çí„É™„Ç¢„É´„Çø„Ç§„É†ÂàÜÊûê</p>

    <div class="main-panel">
        <div class="meter-container">
            <div class="meter-bg"></div>
            <div class="meter-fill"></div>
            <div class="needle" id="needle"></div>
            <div class="needle-cover"></div>
        </div>

        <div>
            <span class="speed-value" id="speed-display">0</span>
            <span class="speed-unit">ÊñáÂ≠ó / ÂàÜ</span>
        </div>
        <div class="feedback-badge" id="feedback">STANDBY</div>

        <textarea class="transcript-box" id="transcript" placeholder="„Éû„Ç§„ÇØ„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„ÄÅËá™Â∑±PR„ÇíË©±„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." readonly></textarea>

        <div style="display:flex; justify-content:center;">
            <button class="btn-mic" id="btn-mic" onclick="toggleRecording()">üéôÔ∏è</button>
        </div>
        
        <p style="margin-top:10px; font-size:12px; color:#999;" id="status-text">„Çø„ÉÉ„Éó„Åó„Å¶Èå≤Èü≥ÈñãÂßã</p>
        <div class="error-msg" id="error-display"></div>
    </div>

    <script>
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        
        let isRecording = false;
        let startTime = 0;
        let totalChars = 0;
        let timerInterval = null;

        const btnMic = document.getElementById('btn-mic');
        const transcriptBox = document.getElementById('transcript');
        const speedDisplay = document.getElementById('speed-display');
        const feedback = document.getElementById('feedback');
        const needle = document.getElementById('needle');
        const statusText = document.getElementById('status-text');
        const errorDisplay = document.getElementById('error-display');

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let currentText = Array.from(event.results)
                    .map(result => result[0].transcript).join('');
                
                transcriptBox.value = currentText;
                totalChars = currentText.replace(/\s+/g, '').length;
                transcriptBox.scrollTop = transcriptBox.scrollHeight;
                
                errorDisplay.innerText = ""; // ÊàêÂäü„Åó„Åü„Çâ„Ç®„É©„ÉºÊ∂à„Åô
            };

            // ‚òÖ„Åì„Åì„Åå‰øÆÊ≠£ÁÇπÔºö„Ç®„É©„Éº„ÅåËµ∑„Åç„Å¶„ÇÇÁ∞°Âçò„Å´„ÅØÊ≠¢„ÇÅ„Å™„ÅÑ
            recognition.onerror = (event) => {
                console.error("Error:", event.error);
                
                if (event.error === 'no-speech') {
                    // ÁÑ°Ë®Ä„Å™„Å†„Åë„Å™„Çâ„Ç®„É©„ÉºË°®Á§∫„Åó„Å™„ÅÑÔºàÂÜçÈñã„Åï„Åõ„Çã„Åü„ÇÅÔºâ
                    return; 
                }
                
                // Êú¨ÂΩì„ÅÆ„Ç®„É©„ÉºÔºà„Éû„Ç§„ÇØË®±ÂèØ„Å™„ÅóÁ≠âÔºâ„Å™„ÇâË°®Á§∫„Åó„Å¶Ê≠¢„ÇÅ„Çã
                if (event.error === 'not-allowed') {
                    errorDisplay.innerText = "„Éû„Ç§„ÇØ„ÅÆË®±ÂèØ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Éñ„É©„Ç¶„Ç∂Ë®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                    stopRecording();
                } else if (event.error === 'network') {
                    errorDisplay.innerText = "„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº„ÄÇ„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
                    stopRecording();
                } else {
                    errorDisplay.innerText = "„Ç®„É©„Éº: " + event.error;
                    // „Åù„ÅÆ‰ªñ„ÅÆË¨é„Ç®„É©„Éº„Å™„Çâ‰∏ÄÊó¶Ê≠¢„ÇÅ„Çã
                    stopRecording(); 
                }
            };

            // ‚òÖ„Åì„Åì„Åå‰øÆÊ≠£ÁÇπÔºöÊ≠¢„Åæ„Å£„Åü„ÇâÂç≥Â∫ß„Å´ÂÜçËµ∑ÂãïÔºàÁ≤ò„ÇäÂº∑„ÅèÔºÅÔºâ
            recognition.onend = () => {
                if (isRecording) {
                    console.log("Restarting recognition...");
                    try {
                        recognition.start();
                    } catch(e) {
                        console.log("Already started");
                    }
                }
            };

        } else {
            alert("„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇGoogle ChromeÊé®Â•®„Åß„Åô„ÄÇ");
            btnMic.disabled = true;
        }

        function toggleRecording() {
            if (!recognition) return;
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            isRecording = true;
            transcriptBox.value = ''; 
            totalChars = 0;
            startTime = Date.now();
            errorDisplay.innerText = ""; // „Ç®„É©„Éº„É™„Çª„ÉÉ„Éà

            try {
                recognition.start();
            } catch(e) {
                console.error(e);
            }
            
            btnMic.classList.add('recording');
            btnMic.innerHTML = '‚¨õ';
            statusText.innerText = "ËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô...";
            feedback.innerText = "MEASURING...";
            feedback.style.background = "#ccc";

            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateSpeed, 500);
        }

        function stopRecording() {
            isRecording = false;
            recognition.stop();
            clearInterval(timerInterval);
            
            btnMic.classList.remove('recording');
            btnMic.innerHTML = 'üéôÔ∏è';
            statusText.innerText = "„Çø„ÉÉ„Éó„Åó„Å¶Èå≤Èü≥ÈñãÂßã";
        }

        function updateSpeed() {
            if (totalChars === 0) return;
            const elapsedTime = (Date.now() - startTime) / 1000;
            const minutes = elapsedTime / 60;
            // ÊúÄÂàù„ÅÆÊï∞Áßí„ÅØÊï∞Â≠ó„ÅåËçí„Çå„Çã„ÅÆ„Åß„ÄÅ5ÁßíÁµå„Å£„Å¶„Åã„ÇâÂà§ÂÆöÈñãÂßã
            if (elapsedTime < 5) return;

            const cpm = Math.round(totalChars / minutes);
            speedDisplay.innerText = cpm;

            let status = '';
            let color = '';
            let angle = -90;

            if (cpm < 200) {
                status = "„ÇÇ„Å£„Å®Êó©„Åè"; color = "#3498db";
                angle = -90 + (cpm / 200) * 60; 
            } else if (cpm <= 350) {
                status = "„ÅÑ„ÅÑ„Éö„Éº„Çπüëç"; color = "#2ecc71";
                angle = -30 + ((cpm - 200) / 150) * 60;
            } else {
                status = "Êó©Âè£Ê≥®ÊÑèÔºÅ"; color = "#e74c3c";
                angle = 30 + ((cpm - 350) / 150) * 60;
            }
            if (angle > 90) angle = 90; 

            feedback.innerText = status;
            feedback.style.background = color;
            needle.style.transform = `rotate(${angle}deg)`;
        }
    </script>
</body>
</html>